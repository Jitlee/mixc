<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>设置</title>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		
		<link rel="stylesheet" href="css/animate.min.css">
		<link rel="stylesheet" href="lib/layer/need/layer.css">
		<link rel="stylesheet" href="css/main.css">
	</head>
	<body>
		<header class="title-bar">
			<a class="active" onclick="tab(this, 0)">版本更新</a>
			<a onclick="tab(this, 1)">服务器配置</a>
			<hr />
			<button class="close" onclick="handleClose()">х</button>
		</header>
		<div id="tabContent0" class="animated bounceInLeft">
			<div class="form-row">
				<div class="form-label">当前版本</div>
				<div class="form-text" id="version">0.0.1</div>
			</div>
			<div class="form-row">
				<div class="form-label">上次更新时间</div>
				<div class="form-text" id="updateTime">2017-01-01 00:00:00</div>
			</div>
			<div class="form-row">
				<div class="form-label">最新版本</div>
				<div class="form-text" id="serverVersion">正在请求数据，请稍后...</div>
			</div>
			<div class="form-row">
				<button id="updateVersionButton" class="button" disabled="disabled" onclick="update()">立即检查更新</button>
				<button class="button" onclick="quit()">关闭应用程序</button>
			</div>
		</div>
		<div id="tabContent1" style="display: none" class="animated bounceInLeft">
			<div class="form-row">
				<div class="form-label">服务器IP</div>
				<input id="server" class="form-input" placeholder="请输入服务器的IP地址" ma/>
			</div>
			<div class="form-row">
				<div class="form-label">服务器端口号</div>
				<input id="port" class="form-input" type="number" placeholder="请输入服务器的端口号" maxlength="5"/>
			</div>
			<div class="form-row">
				<div class="form-label">版本源ID</div>
				<input id="sourceId" class="form-input" type="number" placeholder="请输入客户端版本源ID" maxlength="5"/>
			</div>
			<div class="form-row">
				<button class="button" onclick="save()">保存</button>
			</div>
		</div>
	</body>
	<script src="lib/layer/layer.js"></script>
	<script>
		let remote = require('electron').remote
		let app = remote.app;
		
		let cv = require('./js/checkversion.js')
		readConfig()
		
		function readConfig() {
			let config = cv.readConfig()
			document.getElementById("server").value = config.server
			document.getElementById("port").value = config.port
			document.getElementById("sourceId").value = config.sourceId
			document.getElementById("updateTime").innerText = cv.formatTime(config.updateTime)
			document.getElementById("version").innerText = config.version
		}
		
		function checkVersion() {
			let serverVersionElement = document.getElementById("serverVersion")
			let updateVersionButton = document.getElementById("updateVersionButton")
			updateVersionButton.setAttribute('disabled', 'disabled')
			serverVersionElement.innerText = '正在请求数据，请稍后...'
			cv.checkVersion(function(flag, rst) {
				//loading带文字
				if(flag == 0) {
					serverVersionElement.innerText = document.getElementById("version").innerText
				} else if(flag < 0) {
					serverVersionElement.innerText = '检查版本失败，请重试';
					updateVersionButton.removeAttribute('disabled');
				} else if(flag == 1) {
					serverVersionElement.innerText = rst.releaseVersion;
					updateVersionButton.removeAttribute('disabled')
				}
			})
		}
		checkVersion()
		
		function update() {
			updateVersionButton.setAttribute('disabled', 'disabled')
			cv.checkVersion(function(flag, rst) {
				if(flag == 0) {
					layer.open({content: '已经是最新版本了'});
				} else if(flag == 1) {
					const parent = remote.getCurrentWindow().getParentWindow();
					if(parent && parent.loadFromConfig) {
						parent.loadFromConfig()
					}
					readConfig()
				} else {
					updateVersionButton.removeAttribute('disabled')
					layer.open({content: '检查并更新操作失败，请重试'});
				}
			}, true);
		}
		
		function tab(a, index) {
			if(a.className != "active") {
				a.parentNode.className = 'title-bar tab' + index
				a.className = 'active'
				a.parentNode.children[(index + 1) % 2].className = ''
				document.getElementById("tabContent" + index).style.display = ''
				document.getElementById("tabContent" + (index + 1) % 2).style.display = 'none'
			}
		}
		
		function save() {
			const server = document.getElementById("server").value.replace(/\s+/g, '');
			const port = document.getElementById("port").value.replace(/\s+/g, '');
			const sourceId = document.getElementById("sourceId").value.replace(/\s+/g, '');
			
			if(server.length == 0 || !(port > 80) && !(sourceId > 0)) {
				layer.open({content: '请确认服务器配置是否输入正确'})
			}
			let config = cv.extend({}, cv.config)
			config.server = server
			config.port = Number(port)
			config.sourceId = Number(sourceId)
			cv.saveConfig(config ,function(err){  
		        if(err) {
		        	layer.open({content: '保存失败'})
		        } else {
		        	handleClose();
		        }
		    });  
		}
		
		function handleClose() {
			remote.getCurrentWindow().close()
		}
		
		function quit() {
  			layer.open({
    			content: '您确定要退出应用程序吗？'
    			,btn: ['是的', '不要，我点错了']
    			,yes: function(index){
      				app.quit();
      				layer.close(index);
				}
  			});
			
		}
	</script>
</html>
